# app/domains/energy/llm/llm_indicator_expander.py
import logging
from app import core
from config import ENABLE_REMOVE_SYMBOLS
from ..utils import normalize_symbol_in_string

logger = logging.getLogger("energy.llm.indicator.expander")
if not logger.handlers:
    logging.basicConfig(
        level=logging.INFO,
        format="%(asctime)s | %(levelname)s | %(name)s | %(message)s"
    )


# ============================================================
# åŠ¨æ€æ¸…æ´—ç¤ºä¾‹å‡½æ•°
# ============================================================
def normalize_symbol_example(s: str) -> str:
    """
    æ ¹æ® ENABLE_REMOVE_SYMBOLS åŠ¨æ€æ¸…æ´—ç¤ºä¾‹å­—ç¬¦ä¸²ï¼š
    - ENABLE_REMOVE_SYMBOLS=True  -> åˆ é™¤ # å’Œ å·
    - ENABLE_REMOVE_SYMBOLS=False -> ä¿ç•™åŸæ ·
    """
    if ENABLE_REMOVE_SYMBOLS:
        return s.replace("#", "").replace("å·", "")
    return s

# ============================================================
# å…è®¸åœ¨ format_map ä¸­æ‰§è¡Œ norm("xxx") çš„ dict
# ============================================================
class FormatDict(dict):
    def __missing__(self, key):
        try:
            # å…è®¸åœ¨ {norm("xxx")} ç»“æ„ä¸­æ‰§è¡Œ Python è¡¨è¾¾å¼
            return eval(key, {"norm": normalize_symbol_in_string})
        except Exception:
            return "{" + key + "}"


# ============================================================
# ä¸»é€»è¾‘ï¼šä¸æ”¹åŠ¨ä½ çš„ä»»ä½•ä¸šåŠ¡å†…å®¹ï¼Œåªæ›¿æ¢ prompt æ„é€ æ–¹å¼
# ============================================================
async def expand_indicator_candidates(
        last_indicator_entry: dict | None,
        parsed: dict
):
    """
    é€šç”¨æŒ‡æ ‡æ‰©å±•å™¨ï¼ˆæ”¯æŒ list_query / compare ï¼‰

    å‚æ•°:
    - last_indicator_entry: æœ€è¿‘æˆåŠŸèŠ‚ç‚¹ï¼Œä¾‹å¦‚ graph.get_last_completed_node()["indicator_entry"]
    - parsed: EnergyIntentParser.parse(...) è¿”å›çš„ç»“æ„

    è¿”å›æ‰©å±•åçš„ç»“æ„
    """

    if not last_indicator_entry:
        logger.info("âš ï¸ æ— å†å² indicator_entryï¼Œä¸è¿›è¡Œæ‰©å±•ã€‚")
        return parsed

    if not parsed or "candidates" not in parsed:
        return parsed

    intent = parsed.get("intent")
    candidates = parsed.get("candidates", [])

    base_indicator = last_indicator_entry.get("indicator")
    base_formula = last_indicator_entry.get("formula")
    time_string = last_indicator_entry.get("timeString")
    time_type = last_indicator_entry.get("timeType")

    if not base_indicator:
        logger.info("âš ï¸ å†å²èŠ‚ç‚¹æ—  indicatorï¼Œä¸æ‰©å±•ã€‚")
        return parsed

    # ============================================================
    # åŠ¨æ€æç¤ºè¯ï¼ˆæ ¸å¿ƒï¼šä½¿ç”¨ {norm("xxx")} æ¥æ ¹æ®é…ç½®ç”Ÿæˆç¤ºä¾‹ï¼‰
    # ============================================================

    # ç»™ LLM çš„æŒ‡ä»¤
    prompt_template  = """
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„èƒ½æºæŒ‡æ ‡è‡ªåŠ¨è¡¥å…¨åŠ©æ‰‹ã€‚

ã€å·²çŸ¥å†å²ä¸Šä¸‹æ–‡ã€‘
æœ€è¿‘ä¸€æ¬¡æˆåŠŸæŸ¥è¯¢çš„å®Œæ•´æŒ‡æ ‡ä¸ºï¼š
- æŒ‡æ ‡åç§°: {base_indicator}
- å…¬å¼: {base_formula}
- æ—¶é—´: {time_string} ({time_type})

ã€ç”¨æˆ·å½“å‰æ„å›¾ã€‘
- intent: {intent}
- ç”¨æˆ·æ‹†åˆ†åçš„å­é¡¹: {candidates}
- æ˜¯å¦å¯ç”¨å»é™¤ç‰¹æ®Šç¬¦å·"#|å·"åŠŸèƒ½: {enable_remove_symbols}

ã€ä½ çš„ä»»åŠ¡ã€‘
åŸºäºâ€œæœ€è¿‘æˆåŠŸæŸ¥è¯¢çš„æŒ‡æ ‡â€ä¸ºæ¨¡æ¿ï¼Œå¯¹ç”¨æˆ·æä¾›çš„æ¯ä¸ªå­é¡¹è¿›è¡ŒæŒ‡æ ‡è¡¥å…¨ã€‚

è¡¥å…¨è§„åˆ™ï¼š
1. å®Œæ•´çš„æŒ‡æ ‡åç§°é€šå¸¸åŒ…å«å·¥åºåç§°+å…·ä½“æŒ‡æ ‡åç§°ï¼ˆå¦‚â€œé«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼â€ã€â€œ1é«˜ç‚‰å·¥åºèƒ½è€—è®¡åˆ’ç´¯è®¡å€¼â€ã€â€œå¹´åº¦è®¡åˆ’æŒ‡æ ‡é«˜ç‚‰ç‚¼é“å·¥åºèƒ½è€—èƒ½æºæŒ‡æ ‡å®ç»©ç´¯è®¡å€¼â€ï¼‰ã€‚
2. æ‹†åˆ†åå­é¡¹é€šå¸¸åªåŒ…å«éƒ¨åˆ†ä¿¡æ¯ï¼ˆå¦‚â€œ1#é«˜ç‚‰â€ï¼Œâ€œæœ¬æœˆ2å·é«˜ç‚‰â€ï¼Œâ€œæœ¬å¹´åº¦è®¡åˆ’â€ï¼‰ï¼Œéœ€è¦ä½ æ ¹æ®å†å²æŒ‡æ ‡è¡¥å…¨ä¸ºå®Œæ•´æŒ‡æ ‡åç§°ã€‚
3. å¦‚æœå­é¡¹ä¸­åŒ…å«æ—¶é—´ä¿¡æ¯ï¼Œè¡¥å…¨æ—¶éœ€ä¿ç•™å­é¡¹ä¸­çš„æ—¶é—´ä¿¡æ¯ï¼ˆå¦‚â€œä»Šæ—¥â€ã€â€œæœ¬æœˆâ€ã€â€œæœ¬å¹´åº¦â€ï¼‰ï¼Œå¹¶å°†å…¶æ”¾ç½®åœ¨æŒ‡æ ‡åç§°çš„å¼€å¤´ä½ç½®ã€‚
    ä¾‹å¦‚ï¼š
        è¾“å…¥å­é¡¹ "ä»Šå¤©1#é«˜ç‚‰"
        è‹¥åŸæŒ‡æ ‡ä¸º "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"
        åˆ™è¡¥å…¨ç»“æœï¼š
        "{norm('ä»Šå¤©1#é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼')}"
4. å¦‚æœå­é¡¹ä¸­ä¸åŒ…å«æ—¶é—´ä¿¡æ¯ï¼Œåˆ™ä½¿ç”¨å†å²æŒ‡æ ‡çš„æ—¶é—´ä¿¡æ¯è¿›è¡Œè¡¥å…¨ã€‚ 
   ä½ éœ€è¦æŠŠå®ƒè¡¥å…¨ä¸ºï¼šæ—¶é—´ + å·¥åºåç§° + å…·ä½“æŒ‡æ ‡åç§°
    ä¾‹å¦‚ï¼š
        è¾“å…¥å­é¡¹ "1å·é«˜ç‚‰"
        è‹¥åŸæŒ‡æ ‡ä¸º "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"
        åˆ™è¡¥å…¨ç»“æœï¼š
        "{time_string}({time_type}){norm('1å·é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼')}"
5. è‹¥å­é¡¹ä¸­åªåŒ…å«æ—¶é—´ï¼Œåˆ™ä½¿ç”¨å®Œæ•´æŒ‡æ ‡åç§°è¿›è¡Œè¡¥é½ã€‚
    ä¾‹å¦‚ï¼š
        è¾“å…¥å­é¡¹ "ä¸Šä¸€å¹´"
        è‹¥åŸæŒ‡æ ‡ä¸º "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"
        åˆ™è¡¥å…¨ç»“æœï¼š
            "ä¸Šä¸€å¹´é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"
6. è‹¥å­é¡¹ä¸­ä¸åŒ…å«å·¥åºåç§°ï¼Œåˆ™ä½¿ç”¨å†å²æŒ‡æ ‡ä¸­çš„å·¥åºåç§°è¿›è¡Œè¡¥é½ã€‚
    ä¾‹å¦‚ï¼š  
        è¾“å…¥å­é¡¹ "æœ¬æœˆè®¡åˆ’æŠ¥å‡ºå€¼"
        è‹¥åŸæŒ‡æ ‡ä¸º "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"
        åˆ™è¡¥å…¨ç»“æœï¼š
            "æœ¬æœˆé«˜ç‚‰å·¥åºèƒ½è€—è®¡åˆ’æŠ¥å‡ºå€¼"
7. è‹¥å­é¡¹ä¸­ä¸åŒ…å«å…·ä½“æŒ‡æ ‡åç§°ï¼Œåˆ™ä½¿ç”¨å†å²æŒ‡æ ‡ä¸­çš„å…·ä½“æŒ‡æ ‡åç§°è¿›è¡Œè¡¥é½ã€‚
    ä¾‹å¦‚ï¼š  
        è¾“å…¥å­é¡¹ "2#é«˜ç‚‰æœ¬å¹´åº¦è®¡åˆ’"
        è‹¥åŸæŒ‡æ ‡ä¸º "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"
        åˆ™è¡¥å…¨ç»“æœï¼š
            "{norm('æœ¬å¹´åº¦2#é«˜ç‚‰å·¥åºèƒ½è€—è®¡åˆ’æŠ¥å‡ºå€¼')}"
8. è‹¥å­é¡¹å·²ç»æ˜¯å®Œæ•´æŒ‡æ ‡åç§°ï¼Œåˆ™æ— éœ€è¡¥å…¨ï¼Œç›´æ¥è¿”å›è¯¥åç§°ã€‚
    ä¾‹å¦‚ï¼š  
        è¾“å…¥å­é¡¹ "æœ¬å¹´åº¦1#é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"
        åˆ™è¡¥å…¨ç»“æœï¼š    
            "{norm('æœ¬å¹´åº¦1#é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼')}"
9. åœ¨å…·ä½“æŒ‡æ ‡åç§°ä¸­â€œå®ç»©â€å’Œâ€œè®¡åˆ’â€, â€œæŠ¥å‡ºâ€å’Œâ€œç´¯è®¡â€æ˜¯äº’æ–¥çš„ï¼Œéœ€è¦è¿›è¡Œæ›¿æ¢ã€‚
    ä¾‹å¦‚ï¼š
        è¾“å…¥å­é¡¹ "2#é«˜ç‚‰æœ¬å¹´åº¦è®¡åˆ’"
        è‹¥åŸæŒ‡æ ‡ä¸º "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"
        åˆ™è¡¥å…¨ç»“æœï¼š
            "{norm('æœ¬å¹´åº¦2#é«˜ç‚‰å·¥åºèƒ½è€—è®¡åˆ’æŠ¥å‡ºå€¼')}"
        è¾“å…¥å­é¡¹ "æœ¬æœˆç´¯è®¡"
        è‹¥åŸæŒ‡æ ‡ä¸º "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"
        åˆ™è¡¥å…¨ç»“æœï¼š
            "æœ¬æœˆé«˜ç‚‰å·¥åºèƒ½è€—å®ç»©ç´¯è®¡å€¼"           
10. è‹¥å­é¡¹æ— æ³•æ ¹æ®ä»¥ä¸Šè§„åˆ™è¿›è¡Œè¡¥å…¨æˆ–è€…æ— æ³•ç†è§£å­é¡¹å«ä¹‰ï¼Œåˆ™ä¿æŒä¸å˜ï¼ŒåŸæ ·è¿”å›ã€‚
    ä¾‹å¦‚ï¼š
        è¾“å…¥å­é¡¹ "???"
        åˆ™è¡¥å…¨ç»“æœï¼š
            "???"
11. ä¸ç®¡æ˜¯å¦å¯ç”¨å»é™¤ç‰¹æ®Šç¬¦å·"#|å·"åŠŸèƒ½ï¼Œä¸è¦åœ¨è¡¥å…¨æ—¶éšæ„æ·»åŠ ç‰¹æ®Šç¬¦å·"#"æˆ–"å·"ã€‚ 
    ä¾‹å¦‚ï¼š
        è‹¥åŸæŒ‡æ ‡ä¸º "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"
        è‹¥å¯ç”¨è¯¥åŠŸèƒ½ï¼Œè¾“å…¥å­é¡¹ "æœ¬å¹´åº¦1é«˜ç‚‰"ï¼Œè¡¥å…¨ç»“æœåº”ä¸º "æœ¬å¹´åº¦1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"ï¼ˆè€Œé "æœ¬å¹´åº¦1#é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"ï¼‰
        è‹¥æœªå¯ç”¨è¯¥åŠŸèƒ½ï¼Œè¾“å…¥å­é¡¹ "æœ¬å¹´åº¦1é«˜ç‚‰"ï¼Œè¡¥å…¨ç»“æœåº”ä¸º "æœ¬å¹´åº¦1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"ï¼ˆè€Œé "æœ¬å¹´åº¦1#é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"ï¼‰
12. æœ€ç»ˆä»¥ä¸¥æ ¼ JSON è¿”å›ï¼š
{{
  "intent": "{intent}",
  "candidates": ["è¡¥å…¨åçš„1", "è¡¥å…¨åçš„2", ...]
}}
"""
 # ============================================================
    # ç”¨åŠ¨æ€ FormatDict æ’å€¼
    # ============================================================
    prompt = prompt_template.format_map(FormatDict(
        base_indicator=base_indicator,
        base_formula=base_formula,
        time_string=time_string,
        time_type=time_type,
        intent=intent,
        candidates=candidates,
        enable_remove_symbols=ENABLE_REMOVE_SYMBOLS,
    ))

    try:
        logger.info("ğŸ§© è°ƒç”¨ LLM è¿›è¡ŒæŒ‡æ ‡è¡¥å…¨")
        expanded = await core.safe_llm_parse(prompt)
        logger.info("ğŸ¯ LLM æ‰©å±•æˆåŠŸ: %s", expanded)
        return expanded
    except Exception as e:
        logger.exception("âŒ LLM æ‰©å±•å¤±è´¥ï¼Œè¿”å›åŸ parsed: %s", e)
        return parsed

if __name__ == "__main__":
    import asyncio
    from llm.llm_indicator_expander import expand_indicator_candidates

    # ----------------------------------------------------------
    # æ„é€ æ ‡å‡† last_indicator_entryï¼ˆæ¨¡æ‹Ÿæœ€è¿‘æˆåŠŸçš„æŸ¥è¯¢ï¼‰
    # ----------------------------------------------------------
    last_indicator_entry = {
        "indicator": "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼",
        "formula": "GXNHLT1100.IXRL.SUMVALUE",
        "timeString": "2025-12",
        "timeType": "MONTH"
    }

    # ----------------------------------------------------------
    # æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ â€” è¦†ç›–è§„åˆ™ 1 åˆ° 9ï¼ˆæ¯æ¡è‡³å°‘ä¸€ä¸ªè¾“å…¥ï¼‰
    # ----------------------------------------------------------
    test_cases = [
        # Rule 2ï¼šå­é¡¹åªæœ‰éƒ¨åˆ†ä¿¡æ¯
        {
            "desc": "è§„åˆ™2ï¼šåªåŒ…å«å·¥åºå·ï¼Œåº”è¡¥å…¨æ—¶é—´ + å·¥åº + æŒ‡æ ‡å",
            "parsed": {"intent": "list_query", "candidates": ["1#é«˜ç‚‰"]},
        },

        # Rule 3ï¼šåŒ…å«æ—¶é—´ä¿¡æ¯ï¼Œéœ€ä¿æŒç”¨æˆ·æ—¶é—´
        {
            "desc": "è§„åˆ™3ï¼šåŒ…å«æ—¶é—´ï¼ˆä»Šå¤©ï¼‰ï¼Œéœ€ä¿ç•™æ—¶é—´å‰ç¼€",
            "parsed": {"intent": "list_query", "candidates": ["ä»Šå¤©1å·é«˜ç‚‰"]},
        },

        # Rule 4ï¼šä¸åŒ…å«æ—¶é—´ï¼Œåˆ™ä½¿ç”¨å†å²æ—¶é—´
        {
            "desc": "è§„åˆ™4ï¼šæ— æ—¶é—´ï¼Œè‡ªåŠ¨è¡¥ä¸Šå†å²æ—¶é—´",
            "parsed": {"intent": "list_query", "candidates": ["2#é«˜ç‚‰"]},
        },

        # Rule 5ï¼šåªæœ‰æ—¶é—´ä¿¡æ¯
        {
            "desc": "è§„åˆ™5ï¼šåªåŒ…å«æ—¶é—´ï¼Œåº”è¡¥å…¨å®Œæ•´æŒ‡æ ‡åç§°",
            "parsed": {"intent": "list_query", "candidates": ["ä¸Šä¸€å¹´"]},
        },

        # Rule 6ï¼šæ— å·¥åºåç§°ï¼Œä½¿ç”¨å†å²å·¥åº
        {
            "desc": "è§„åˆ™6ï¼šç¼ºå°‘å·¥åºåç§°ï¼Œåº”ç»§æ‰¿å†å²å·¥åº",
            "parsed": {"intent": "list_query", "candidates": ["æœ¬æœˆè®¡åˆ’æŠ¥å‡ºå€¼"]},
        },

        # Rule 7ï¼šç¼ºå°‘å…·ä½“æŒ‡æ ‡åç§°
        {
            "desc": "è§„åˆ™7ï¼šç¼ºå°‘æŒ‡æ ‡åï¼Œåº”ç»§æ‰¿å†å²æŒ‡æ ‡å",
            "parsed": {"intent": "list_query", "candidates": ["2#é«˜ç‚‰æœ¬å¹´åº¦è®¡åˆ’"]},
        },

        # Rule 8ï¼šå­é¡¹å·²å®Œæ•´ï¼ŒLLM åº”åŸæ ·è¾“å‡º
        {
            "desc": "è§„åˆ™8ï¼šå­é¡¹å·²å®Œæ•´ï¼Œæ— éœ€è¡¥å…¨",
            "parsed": {"intent": "list_query", "candidates": ["æœ¬å¹´åº¦1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"]},
        },

        # Rule 9ï¼šæ— æ³•è¡¥å…¨çš„æƒ…å†µ
        {
            "desc": "è§„åˆ™9ï¼šæœªçŸ¥å†…å®¹ï¼Œä¿æŒä¸å˜",
            "parsed": {"intent": "list_query", "candidates": ["???"]},
        },
    ]

    # ----------------------------------------------------------
    # æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
    # ----------------------------------------------------------
    async def run_tests():
        for idx, case in enumerate(test_cases, 1):
            print("\n========================================")
            print(f"ğŸ§ª Test {idx}: {case['desc']}")
            print("========================================")

            result = await expand_indicator_candidates(
                last_indicator_entry=last_indicator_entry,
                parsed=case["parsed"],
            )

            print("â¡ï¸ è¾“å…¥:", case["parsed"])
            print("â¬…ï¸ LLM è¿”å›:", result)

    asyncio.run(run_tests())
