# æµ‹è¯•å•æŒ‡æ ‡æŸ¥è¯¢
reply, graph_state = await handle_single_query(user_id, "1å·é«˜ç‚‰å·¥åºèƒ½è€—", graph)
print("Single Query Reply:", reply)
print(json.dumps(graph_state, indent=2, ensure_ascii=False))

# æµ‹è¯•é€‰æ‹©å¤‡é€‰
reply, graph_state = await handle_clarify(user_id, 1, graph)
print("Single Query Reply 2:", reply)
print(json.dumps(graph_state, indent=2, ensure_ascii=False))


(myenv) fusionshen@fusionshen-ThinkPad-T14-Gen-1:~/Desktop/LLM/ask_agent$ python -m core.pipeline_handlers
2025-11-12 16:08:59,380 | INFO | llm_client | âœ… Using ChatOllama from langchain-ollama
/home/fusionshen/myenv/lib/python3.12/site-packages/jieba/_compat.py:18: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
  import pkg_resources
âœ… sentence-transformers ç‰ˆæœ¬: 5.1.1
<frozen runpy>:128: RuntimeWarning: 'core.pipeline_handlers' found in sys.modules after import of package 'core', but prior to execution of 'core.pipeline_handlers'; this may result in unpredictable behaviour
2025-11-12 16:09:02,608 | INFO | formula-api | ğŸ”„ æ­£åœ¨åˆå§‹åŒ–å…¬å¼æ•°æ®ï¼ˆfull loadï¼‰...
Building prefix dict from the default dictionary ...
2025-11-12 16:09:05,867 | DEBUG | jieba | Building prefix dict from the default dictionary ...
Loading model from cache /tmp/jieba.cache
2025-11-12 16:09:05,867 | DEBUG | jieba | Loading model from cache /tmp/jieba.cache
Loading model cost 0.593 seconds.
2025-11-12 16:09:06,461 | DEBUG | jieba | Loading model cost 0.593 seconds.
Prefix dict has been built successfully.
2025-11-12 16:09:06,461 | DEBUG | jieba | Prefix dict has been built successfully.
2025-11-12 16:09:19,712 | INFO | formula-api | âœ… Loaded 270817 formulas. Tokenization ready.
HAVE_ST : True
2025-11-12 16:09:19,718 | INFO | formula-api | Auto-selected embedding device: cpu
OFFLINE_MODEL_PATH:/home/fusionshen/Desktop/LLM/ask_agent/models/sbert_offline_models/86741b4e3f5cb7765a600d3a3d55a0f6a6cb443d
2025-11-12 16:09:19,718 | INFO | formula-api | ğŸ§© å°è¯•åŠ è½½æœ¬åœ°æ¨¡å‹: /home/fusionshen/Desktop/LLM/ask_agent/models/sbert_offline_models/86741b4e3f5cb7765a600d3a3d55a0f6a6cb443d
2025-11-12 16:09:19,719 | INFO | sentence_transformers.SentenceTransformer | Load pretrained SentenceTransformer: /home/fusionshen/Desktop/LLM/ask_agent/models/sbert_offline_models/86741b4e3f5cb7765a600d3a3d55a0f6a6cb443d
2025-11-12 16:09:20,678 | INFO | formula-api | âœ… å·²æˆåŠŸåŠ è½½ç¦»çº¿æ¨¡å‹ã€‚
2025-11-12 16:09:21,275 | INFO | formula-api | âœ… Loaded embeddings from cache ((270817, 384))
2025-11-12 16:09:21,276 | INFO | formula-api | âœ… åˆå§‹åŒ–å®Œæˆï¼Œç”¨æ—¶ 18.67s
2025-11-12 16:09:21,276 | INFO | pipeline.handlers | âœ… è¿›å…¥ single query æ¨¡å¼ã€‚
2025-11-12 16:09:21,276 | INFO | pipeline.handlers | ğŸ”¹ handle_single_query user_input=1å·é«˜ç‚‰å·¥åºèƒ½è€—
2025-11-12 16:09:21,345 | INFO | httpx | HTTP Request: GET http://192.168.92.13:11434/api/tags "HTTP/1.1 200 OK"
2025-11-12 16:09:29,458 | INFO | httpx | HTTP Request: POST http://192.168.92.13:11434/api/chat "HTTP/1.1 200 OK"
```json
{
  "indicator": "1å·é«˜ç‚‰å·¥åºèƒ½è€—",
  "timeString": null,
  "timeType": null
}
```
2025-11-12 16:09:30,502 | INFO | llm_client | âœ… ä» LLM è¾“å‡ºä¸­æˆåŠŸè§£æ JSONã€‚
Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:00<00:00,  6.93it/s]
2025-11-12 16:09:31,486 | INFO | context_graph | ğŸ•˜ add_history: 1å·é«˜ç‚‰å·¥åºèƒ½è€— -> è¯·ä»ä»¥ä¸‹å€™é€‰å…¬å¼é€‰æ‹©ç¼–å·ï¼š
1) 1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (score 87.77)
2) é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (score 87.20)
3) 1é«˜ç‚‰å·¥åºå¹³è¡¡èƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (score 86.29)
4) é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©ç´¯è®¡å€¼ (score 85.74)
5) 1é«˜ç‚‰å·¥åºå¹³è¡¡èƒ½è€—å®ç»©ç´¯è®¡å€¼ (score 85.73)
Single Query Reply: è¯·ä»ä»¥ä¸‹å€™é€‰å…¬å¼é€‰æ‹©ç¼–å·ï¼š
1) 1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (score 87.77)
2) é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (score 87.20)
3) 1é«˜ç‚‰å·¥åºå¹³è¡¡èƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (score 86.29)
4) é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©ç´¯è®¡å€¼ (score 85.74)
5) 1é«˜ç‚‰å·¥åºå¹³è¡¡èƒ½è€—å®ç»©ç´¯è®¡å€¼ (score 85.73)
{
  "graph": {
    "nodes": [],
    "relations": [],
    "_next_id": 1
  },
  "meta": {
    "history": [
      {
        "ask": "1å·é«˜ç‚‰å·¥åºèƒ½è€—",
        "reply": "è¯·ä»ä»¥ä¸‹å€™é€‰å…¬å¼é€‰æ‹©ç¼–å·ï¼š\n1) 1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (score 87.77)\n2) é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (score 87.20)\n3) 1é«˜ç‚‰å·¥åºå¹³è¡¡èƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (score 86.29)\n4) é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©ç´¯è®¡å€¼ (score 85.74)\n5) 1é«˜ç‚‰å·¥åºå¹³è¡¡èƒ½è€—å®ç»©ç´¯è®¡å€¼ (score 85.73)"
      }
    ],
    "current_intent_info": {
      "user_input_list": [
        "1å·é«˜ç‚‰å·¥åºèƒ½è€—"
      ],
      "intent_list": [
        "single_query"
      ],
      "indicators": [
        {
          "status": "active",
          "indicator": "1å·é«˜ç‚‰å·¥åºèƒ½è€—",
          "formula": null,
          "timeString": null,
          "timeType": null,
          "slot_status": {
            "formula": "missing",
            "time": "missing"
          },
          "value": null,
          "note": null,
          "formula_candidates": [
            {
              "number": 1,
              "FORMULAID": "GXNHLT1101.IXRL",
              "FORMULANAME": "1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼",
              "score": 87.768,
              "fuzzy_score": 99.1636,
              "semantic_score": 67.9943,
              "match_kind": "hybrid"
            },
            {
              "number": 2,
              "FORMULAID": "GXNHLT1100.IXRL",
              "FORMULANAME": "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼",
              "score": 87.2049,
              "fuzzy_score": 87.264,
              "semantic_score": 75.0671,
              "match_kind": "hybrid"
            },
            {
              "number": 3,
              "FORMULAID": "PHNHLT1101.IXRL",
              "FORMULANAME": "1é«˜ç‚‰å·¥åºå¹³è¡¡èƒ½è€—å®ç»©æŠ¥å‡ºå€¼",
              "score": 86.2949,
              "fuzzy_score": 99.1636,
              "semantic_score": 65.7436,
              "match_kind": "hybrid"
            },
            {
              "number": 4,
              "FORMULAID": "GXNHLT1100.IXRL.SUMVALUE",
              "FORMULANAME": "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©ç´¯è®¡å€¼",
              "score": 85.7415,
              "fuzzy_score": 84.672,
              "semantic_score": 78.5695,
              "match_kind": "hybrid"
            },
            {
              "number": 5,
              "FORMULAID": "PHNHLT1101.IXRL.SUMVALUE",
              "FORMULANAME": "1é«˜ç‚‰å·¥åºå¹³è¡¡èƒ½è€—å®ç»©ç´¯è®¡å€¼",
              "score": 85.7281,
              "fuzzy_score": 96.2182,
              "semantic_score": 70.851,
              "match_kind": "hybrid"
            }
          ]
        }
      ]
    }
  }
}
2025-11-12 16:09:31,487 | INFO | pipeline.handlers | âœ… è¿›å…¥ clarify æ¨¡å¼ã€‚
2025-11-12 16:09:31,487 | INFO | pipeline.handlers | ğŸ”¹ handle_clarify user_input=1
2025-11-12 16:09:31,487 | INFO | pipeline.handlers | ğŸ”¢ æ£€æµ‹åˆ°å€™é€‰é€‰æ‹© index=0, count=5
2025-11-12 16:09:31,487 | INFO | pipeline.handlers | âœ… ç”¨æˆ·é€‰æ‹©å…¬å¼: 1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (FORMULAID=GXNHLT1101.IXRL)
2025-11-12 16:09:31,487 | INFO | context_graph | ğŸ•˜ add_history: 1 -> å¥½çš„ï¼Œè¦æŸ¥ã€1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ã€‘ï¼Œè¯·å‘Šè¯‰æˆ‘æ—¶é—´ã€‚
Single Query Reply 2: å¥½çš„ï¼Œè¦æŸ¥ã€1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ã€‘ï¼Œè¯·å‘Šè¯‰æˆ‘æ—¶é—´ã€‚
{
  "graph": {
    "nodes": [],
    "relations": [],
    "_next_id": 1
  },
  "meta": {
    "history": [
      {
        "ask": "1å·é«˜ç‚‰å·¥åºèƒ½è€—",
        "reply": "è¯·ä»ä»¥ä¸‹å€™é€‰å…¬å¼é€‰æ‹©ç¼–å·ï¼š\n1) 1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (score 87.77)\n2) é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (score 87.20)\n3) 1é«˜ç‚‰å·¥åºå¹³è¡¡èƒ½è€—å®ç»©æŠ¥å‡ºå€¼ (score 86.29)\n4) é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©ç´¯è®¡å€¼ (score 85.74)\n5) 1é«˜ç‚‰å·¥åºå¹³è¡¡èƒ½è€—å®ç»©ç´¯è®¡å€¼ (score 85.73)"
      },
      {
        "ask": "1",
        "reply": "å¥½çš„ï¼Œè¦æŸ¥ã€1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ã€‘ï¼Œè¯·å‘Šè¯‰æˆ‘æ—¶é—´ã€‚"
      }
    ],
    "current_intent_info": {
      "user_input_list": [
        "1å·é«˜ç‚‰å·¥åºèƒ½è€—",
        "1"
      ],
      "intent_list": [
        "single_query",
        "clarify"
      ],
      "indicators": [
        {
          "status": "active",
          "indicator": "1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼",
          "formula": "GXNHLT1101.IXRL",
          "timeString": null,
          "timeType": null,
          "slot_status": {
            "formula": "filled",
            "time": "missing"
          },
          "value": null,
          "note": "å¥½çš„ï¼Œè¦æŸ¥ã€1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ã€‘ï¼Œè¯·å‘Šè¯‰æˆ‘æ—¶é—´ã€‚",
          "formula_candidates": [
            {
              "number": 1,
              "FORMULAID": "GXNHLT1101.IXRL",
              "FORMULANAME": "1é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼",
              "score": 87.768,
              "fuzzy_score": 99.1636,
              "semantic_score": 67.9943,
              "match_kind": "hybrid"
            },
            {
              "number": 2,
              "FORMULAID": "GXNHLT1100.IXRL",
              "FORMULANAME": "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼",
              "score": 87.2049,
              "fuzzy_score": 87.264,
              "semantic_score": 75.0671,
              "match_kind": "hybrid"
            },
            {
              "number": 3,
              "FORMULAID": "PHNHLT1101.IXRL",
              "FORMULANAME": "1é«˜ç‚‰å·¥åºå¹³è¡¡èƒ½è€—å®ç»©æŠ¥å‡ºå€¼",
              "score": 86.2949,
              "fuzzy_score": 99.1636,
              "semantic_score": 65.7436,
              "match_kind": "hybrid"
            },
            {
              "number": 4,
              "FORMULAID": "GXNHLT1100.IXRL.SUMVALUE",
              "FORMULANAME": "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©ç´¯è®¡å€¼",
              "score": 85.7415,
              "fuzzy_score": 84.672,
              "semantic_score": 78.5695,
              "match_kind": "hybrid"
            },
            {
              "number": 5,
              "FORMULAID": "PHNHLT1101.IXRL.SUMVALUE",
              "FORMULANAME": "1é«˜ç‚‰å·¥åºå¹³è¡¡èƒ½è€—å®ç»©ç´¯è®¡å€¼",
              "score": 85.7281,
              "fuzzy_score": 96.2182,
              "semantic_score": 70.851,
              "match_kind": "hybrid"
            }
          ]
        }
      ]
    }
  }
}