    from tools import formula_api
    # åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¸ä¼šé‡å¤åŠ è½½
    formula_api.initialize()

    user_id = "test_user"
    graph = get_graph(user_id) or ContextGraph()
    set_graph(user_id, graph)

    # æµ‹è¯•å•æŒ‡æ ‡æŸ¥è¯¢
    reply, _, _ = await handle_single_query(user_id, "ä»Šå¤©çš„é«˜ç‚‰å·¥åºèƒ½è€—æ˜¯å¤šå°‘", graph)
    print("Single Query Reply:", reply)

    from core.llm_energy_intent_parser import EnergyIntentParser
    parser = EnergyIntentParser()
    user_input = "å¯¹æ¯”ä¸Šæœˆæœ‰ä»€ä¹ˆå˜åŒ–"
    current_info = await parser.parse_intent(user_input)
    print(current_info)

    # æµ‹è¯•äºŒæ­¥å¯¹æ¯”
    reply, _, _ = await handle_compare(user_id, user_input, graph, current_info)
    print("Single Query Reply 2:", reply)

PS E:\Work\LLM\xiaozhi_mcp\ask_agent> & E:/Work/LLM/xiaozhi_mcp/ask_agent/ask_agent_venv/Scripts/Activate.ps1
(ask_agent_venv) PS E:\Work\LLM\xiaozhi_mcp\ask_agent> python -m core.pipeline_handlers
2025-12-04 12:37:20,004 | INFO | llm_client | âœ… Using ChatOllama from langchain-ollama
E:\Work\LLM\xiaozhi_mcp\ask_agent\ask_agent_venv\Lib\site-packages\jieba\_compat.py:18: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
  import pkg_resources
âœ… sentence-transformers ç‰ˆæœ¬: 5.1.1
<frozen runpy>:128: RuntimeWarning: 'core.pipeline_handlers' found in sys.modules after import of package 'core', but prior to execution of 'core.pipeline_handlers'; this may result in unpredictable behaviour
2025-12-04 12:37:24,572 | INFO | formula-api | ğŸ”„ æ­£åœ¨åˆå§‹åŒ–å…¬å¼æ•°æ®ï¼ˆfull loadï¼‰...
Building prefix dict from the default dictionary ...
2025-12-04 12:37:28,826 | DEBUG | jieba | Building prefix dict from the default dictionary ...
Loading model from cache C:\Users\FUSION~1\AppData\Local\Temp\jieba.cache
2025-12-04 12:37:28,826 | DEBUG | jieba | Loading model from cache C:\Users\FUSION~1\AppData\Local\Temp\jieba.cache
Loading model cost 0.736 seconds.
2025-12-04 12:37:29,562 | DEBUG | jieba | Loading model cost 0.736 seconds.
Prefix dict has been built successfully.
2025-12-04 12:37:29,563 | DEBUG | jieba | Prefix dict has been built successfully.
2025-12-04 12:37:46,674 | INFO | formula-api | âœ… Loaded 270817 formulas. Tokenization ready.
HAVE_ST : True
2025-12-04 12:37:46,675 | INFO | formula-api | Auto-selected embedding device: cpu
OFFLINE_MODEL_PATH:E:\Work\LLM\xiaozhi_mcp\ask_agent\models\sbert_offline_models\86741b4e3f5cb7765a600d3a3d55a0f6a6cb443d
2025-12-04 12:37:46,675 | INFO | formula-api | ğŸ§© å°è¯•åŠ è½½æœ¬åœ°æ¨¡å‹: E:\Work\LLM\xiaozhi_mcp\ask_agent\models\sbert_offline_models\86741b4e3f5cb7765a600d3a3d55a0f6a6cb443d
2025-12-04 12:37:46,678 | INFO | sentence_transformers.SentenceTransformer | Load pretrained SentenceTransformer: E:\Work\LLM\xiaozhi_mcp\ask_agent\models\sbert_offline_models\86741b4e3f5cb7765a600d3a3d55a0f6a6cb443d
2025-12-04 12:37:47,684 | INFO | formula-api | âœ… å·²æˆåŠŸåŠ è½½ç¦»çº¿æ¨¡å‹ã€‚
2025-12-04 12:37:47,856 | INFO | formula-api | âœ… Loaded embeddings from cache ((270817, 384))
2025-12-04 12:37:47,856 | INFO | formula-api | âœ… åˆå§‹åŒ–å®Œæˆï¼Œç”¨æ—¶ 23.28s
2025-12-04 12:37:47,865 | INFO | pipeline_context | ğŸ“‚ åŠ è½½ç”¨æˆ·å›¾è°± test_user <- E:\Work\LLM\xiaozhi_mcp\ask_agent\core\../data/graphs\test_user.pkl.gz
2025-12-04 12:37:47,865 | INFO | pipeline.handlers | ğŸ”µ [single] enter | user_input=ä»Šå¤©çš„é«˜ç‚‰å·¥åºèƒ½è€—æ˜¯å¤šå°‘
âš ï¸ æ— èŠ‚ç‚¹å¯æ¢å¤ intent_info
2025-12-04 12:37:47,865 | INFO | pipeline.handlers | âš ï¸ æ— å†å²èŠ‚ç‚¹å¯ç”¨ï¼Œåˆ›å»ºé»˜è®¤ indicatorã€‚
2025-12-04 12:37:47,865 | INFO | pipeline.handlers | ğŸ”¹ active indicator = None
2025-12-04 12:37:48,148 | INFO | pipeline_context | ğŸ’¾ å¼‚æ­¥ä¿å­˜ç”¨æˆ·å›¾è°± test_user -> E:\Work\LLM\xiaozhi_mcp\ask_agent\core\../data/graphs\test_user.pkl.gz
2025-12-04 12:37:48,149 | INFO | pipeline_context | ğŸ“ ä¿å­˜ JSON è°ƒè¯•æ–‡ä»¶ test_user -> E:\Work\LLM\xiaozhi_mcp\ask_agent\core\../data/graphs\test_user.json
2025-12-04 12:37:48,192 | INFO | httpx | HTTP Request: GET http://10.8.0.178:11434/api/tags "HTTP/1.1 200 OK"
2025-12-04 12:37:48,193 | INFO | llm_client | ğŸŒ Using remote Ollama model: gemma3:27b
2025-12-04 12:37:50,634 | INFO | httpx | HTTP Request: POST http://10.8.0.178:11434/api/chat "HTTP/1.1 200 OK"
```json
{
  "indicator": "é«˜ç‚‰å·¥åºèƒ½è€—",
  "timeString": "2025-12-04",
  "timeType": "DAY"
}
```
2025-12-04 12:37:51,882 | INFO | context_graph | ğŸ§© ä»ç”¨æˆ·åå¥½æ¢å¤ é«˜ç‚‰å·¥åºèƒ½è€— -> None
2025-12-04 12:37:52,031 | INFO | formula-api | âœ… Hierarchical exact match: é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼
ğŸŸ¢ ç™»å½•è¿”å›ï¼š {'error': None, 'data': {'token': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiIxNDMiLCJ0ZW5hbnRpZCI6IjEwNSIsInVuYW1lIjoi566h55CG5ZGYIiwidG5hbWUiOiLlrp3pkqLmuZvmsZ_pkqLpk4HmnInpmZDlhazlj7giLCJ0c2lkZSI6IjEiLCJncm91cGlkIjoiMCIsInNsaWRpbmciOiIwIiwicnNpbmNlIjoiMTc2NDk2Njc3MSIsIm5iZiI6MTc2NDgyMjQ3MSwiZXhwIjoxNzY0OTM4MjcxLCJpc3MiOiJzaGJhb25lbmciLCJhdWQiOiJzaGJhb25lbmcifQ.Z5IMPyPpNc6S7SuTgB-Xffo9Moi70C36lW3xu4ZHqXs', 'expiresAt': '2025-12-05 20:36:51', 'tenantId': 105, 'tenancyName': 'zjis', 'userId': 143, 'userName': 'admin'}, 'status': 200, 'msg': ' æ“ä½œæˆåŠŸ', 'duration': -1}
ğŸŸ¡ è°ƒç”¨æ¥å£: http://www.shbaoenergy.com:8081/emscore/api/services/nYMC/calcData/QueryItemValuesAsync
ğŸ§© è¯·æ±‚å‚æ•°: {'expressionList': {'GXNHLT1100.IXRL': 'GXNHLT1100.IXRL'}, 'clock': '2025-12-04', 'timegranId': 'DAY'}
ğŸŸ¢ è¿”å›æ•°æ®: {'error': None, 'data': {'GXNHLT1100.IXRL': None}, 'status': 200, 'msg': 'æ“ä½œæˆåŠŸ', 'duration': -1}
2025-12-04 12:37:52,217 | INFO | pipeline.handlers | âš™ï¸ å¹³å°æŸ¥è¯¢æˆåŠŸ: {'GXNHLT1100.IXRL': None}
2025-12-04 12:37:52,218 | INFO | context_graph | ğŸ†• ContextGraph.add_node: æ–°å»ºèŠ‚ç‚¹ id=1, indicator=é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼, time=2025-12-04   
2025-12-04 12:37:52,218 | INFO | context_graph | ğŸ•˜ add_history: ä»Šå¤©çš„é«˜ç‚‰å·¥åºèƒ½è€—æ˜¯å¤šå°‘ -> âœ… é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ åœ¨ 2025-12-04 (DAY) çš„ å€¼æš‚æ— æ•°æ®ã€‚
Single Query Reply: âœ… é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ åœ¨ 2025-12-04 (DAY) çš„å€¼æš‚æ— æ•°æ®ã€‚
2025-12-04 12:37:52,219 | INFO | pipeline_context | ğŸ’¾ å¼‚æ­¥ä¿å­˜ç”¨æˆ·å›¾è°± test_user -> E:\Work\LLM\xiaozhi_mcp\ask_agent\core\../data/graphs\test_user.pkl.gz
2025-12-04 12:37:52,221 | INFO | pipeline_context | ğŸ“ ä¿å­˜ JSON è°ƒè¯•æ–‡ä»¶ test_user -> E:\Work\LLM\xiaozhi_mcp\ask_agent\core\../data/graphs\test_user.json
2025-12-04 12:37:52,240 | INFO | httpx | HTTP Request: GET http://10.8.0.178:11434/api/tags "HTTP/1.1 200 OK"
2025-12-04 12:37:52,241 | INFO | llm_client | ğŸŒ Using remote Ollama model: gemma3:27b
2025-12-04 12:37:54,267 | INFO | httpx | HTTP Request: POST http://10.8.0.178:11434/api/chat "HTTP/1.1 200 OK"
{"intent":"compare","candidates":["ä¸Šæœˆ"]}
2025-12-04 12:37:54,575 | INFO | llm_energy_intent_parser | [parse_intent] user_input=å¯¹æ¯”ä¸Šæœˆæœ‰ä»€ä¹ˆå˜åŒ– => {'intent': 'compare', 'candidates': ['ä¸Šæœˆ']}
{'intent': 'compare', 'candidates': ['ä¸Šæœˆ']}
2025-12-04 12:37:54,576 | INFO | pipeline.handlers | ğŸ”€ [compare] enter | user=test_user, input=å¯¹æ¯”ä¸Šæœˆæœ‰ä»€ä¹ˆå˜åŒ–
âœ… å·²ä»æœ€è¿‘èŠ‚ç‚¹æ¢å¤ intent_info: {'user_input_list': ['ä»Šå¤©çš„é«˜ç‚‰å·¥åºèƒ½è€—æ˜¯å¤šå°‘'], 'intent_list': ['single_query'], 'indicators': [{'status': 'completed', 'indicator': 'é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼', 'formula': 'GXNHLT1100.IXRL', 'timeString': '2025-12-04', 'timeType': 'DAY', 'slot_status': {'formula': 'filled', 'time': 'filled'}, 'value': None, 'note': 'âœ… é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ åœ¨ 2025-12-04 (DAY) çš„å€¼æš‚æ— æ•°æ®ã€‚', 'formula_candidates': None}]}
2025-12-04 12:37:54,576 | INFO | context_graph | ğŸ¯ set_main_intent: compare
2025-12-04 12:37:54,577 | INFO | llm_indicator_expander | ğŸ§© è°ƒç”¨ LLM è¿›è¡ŒæŒ‡æ ‡è¡¥å…¨
2025-12-04 12:37:54,602 | INFO | httpx | HTTP Request: GET http://10.8.0.178:11434/api/tags "HTTP/1.1 200 OK"
2025-12-04 12:37:54,650 | INFO | llm_client | ğŸŒ Using remote Ollama model: gemma3:27b
2025-12-04 12:37:56,914 | INFO | httpx | HTTP Request: POST http://10.8.0.178:11434/api/chat "HTTP/1.1 200 OK"
```json
{
  "intent": "compare",
  "candidates": [
    "ä¸Šæœˆé«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼"
  ]
}
```
2025-12-04 12:37:58,036 | INFO | llm_indicator_expander | ğŸ¯ LLM æ‰©å±•æˆåŠŸ: {'intent': 'compare', 'candidates': ['ä¸Šæœˆé«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼']}
2025-12-04 12:37:58,036 | INFO | pipeline.handlers | ğŸ” compare: two-step (single candidate)
2025-12-04 12:37:58,063 | INFO | httpx | HTTP Request: GET http://10.8.0.178:11434/api/tags "HTTP/1.1 200 OK"
2025-12-04 12:37:58,063 | INFO | llm_client | ğŸŒ Using remote Ollama model: gemma3:27b
2025-12-04 12:38:00,478 | INFO | httpx | HTTP Request: POST http://10.8.0.178:11434/api/chat "HTTP/1.1 200 OK"
```json
{
  "indicator": "é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼",
  "timeString": "2025-11",
  "timeType": "MONTH"
}
```
2025-12-04 12:38:01,829 | INFO | context_graph | ğŸ§© ä»ç”¨æˆ·åå¥½æ¢å¤ é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ -> None
2025-12-04 12:38:01,974 | INFO | formula-api | âœ… Hierarchical exact match: é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼
ğŸŸ¡ è°ƒç”¨æ¥å£: http://www.shbaoenergy.com:8081/emscore/api/services/nYMC/calcData/QueryItemValuesAsync
ğŸ§© è¯·æ±‚å‚æ•°: {'expressionList': {'GXNHLT1100.IXRL': 'GXNHLT1100.IXRL'}, 'clock': '2025-11', 'timegranId': 'MONTH'}
ğŸŸ¢ è¿”å›æ•°æ®: {'error': None, 'data': {'GXNHLT1100.IXRL': None}, 'status': 200, 'msg': 'æ“ä½œæˆåŠŸ', 'duration': -1}
2025-12-04 12:38:02,112 | INFO | pipeline.handlers | âš™ï¸ å¹³å°æŸ¥è¯¢æˆåŠŸ: {'GXNHLT1100.IXRL': None}
2025-12-04 12:38:02,113 | INFO | context_graph | ğŸ†• ContextGraph.add_node: æ–°å»ºèŠ‚ç‚¹ id=2, indicator=é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼, time=2025-11      
2025-12-04 12:38:02,134 | INFO | httpx | HTTP Request: GET http://10.8.0.178:11434/api/tags "HTTP/1.1 200 OK"
2025-12-04 12:38:02,136 | INFO | llm_client | ğŸŒ Using remote Ollama model: gemma3:27b
2025-12-04 12:38:03,762 | INFO | httpx | HTTP Request: POST http://10.8.0.178:11434/api/chat "HTTP/1.1 200 OK"
2025-12-04 12:38:04,209 | INFO | llm.indicator.compare | ğŸ” compare LLM è¾“å‡º: ç”±äºä¸¤ä¸ªæŸ¥è¯¢éƒ½æœªè¿”å›æœ‰æ•ˆæ•°æ®ï¼Œæ— æ³•å¯¹ä»»ä½•æŒ‡æ ‡è¿›è¡Œæ¯”è¾ƒã€‚
2025-12-04 12:38:04,209 | INFO | context_graph | ğŸ”— ContextGraph.add_relation: compare (source=1 target=2) meta={'via': 'pipeline.compare', 'user_input': ['ä»Šå¤©çš„é«˜ç‚‰å·¥åºèƒ½è€—æ˜¯å¤šå°‘', 'å¯¹æ¯”ä¸Šæœˆæœ‰ä»€ä¹ˆå˜åŒ–'], 'result': 'ç”±äºä¸¤ä¸ªæŸ¥è¯¢éƒ½æœªè¿”å›æœ‰æ•ˆæ•°æ®ï¼Œæ— æ³•å¯¹ä»»ä½•æŒ‡æ ‡è¿›è¡Œæ¯”è¾ƒã€‚'}
ğŸ”” left_entry: {'id': 1, 'indicator_entry': {'status': 'completed', 'indicator': 'é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼', 'formula': 'GXNHLT1100.IXRL', 'timeString': '2025-12-04', 'timeType': 'DAY', 'slot_status': {'formula': 'filled', 'time': 'filled'}, 'value': None, 'note': 'âœ… é«˜ç‚‰å·¥åºèƒ½è€—å®ç»© æŠ¥å‡ºå€¼ åœ¨ 2025-12-04 (DAY) çš„å€¼æš‚æ— æ•°æ®ã€‚', 'formula_candidates': None}, 'intent_info_snapshot': {'user_input_list': ['ä»Šå¤©çš„é«˜ç‚‰å·¥åºèƒ½è€—æ˜¯å¤š å°‘'], 'intent_list': ['single_query'], 'indicators': [{'status': 'completed', 'indicator': 'é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼', 'formula': 'GXNHLT1100.IXRL', 'timeString': '2025-12-04', 'timeType': 'DAY', 'slot_status': {'formula': 'filled', 'time': 'filled'}, 'value': None, 'note': 'âœ… é«˜ç‚‰å·¥ åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ åœ¨ 2025-12-04 (DAY) çš„å€¼æš‚æ— æ•°æ®ã€‚', 'formula_candidates': None}]}}
 right_entry: {'id': 2, 'indicator_entry': {'status': 'completed', 'indicator': 'é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼', 'formula': 'GXNHLT1100.IXRL', 'timeString': '2025-11', 'timeType': 'MONTH', 'slot_status': {'formula': 'filled', 'time': 'filled'}, 'value': None, 'note': 'âœ… é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥ å‡ºå€¼ åœ¨ 2025-11 (MONTH) çš„å€¼æš‚æ— æ•°æ®ã€‚', 'formula_candidates': None}, 'intent_info_snapshot': {'user_input_list': ['ä»Šå¤©çš„é«˜ç‚‰å·¥åºèƒ½è€—æ˜¯å¤šå°‘', 'å¯¹æ¯”ä¸Šæœˆæœ‰ä»€ä¹ˆå˜åŒ–'], 'intent_list': ['single_query', 'compare'], 'indicators': [{'status': 'completed', 'indicator': 'é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡º å€¼', 'formula': 'GXNHLT1100.IXRL', 'timeString': '2025-12-04', 'timeType': 'DAY', 'slot_status': {'formula': 'filled', 'time': 'filled'}, 'value': None, 'note': 'âœ… é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ åœ¨ 2025-12-04 (DAY) çš„å€¼æš‚æ— æ•°æ®ã€‚', 'formula_candidates': None}, {'status': 'completed', 'indicator': 'é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼', 'formula': 'GXNHLT1100.IXRL', 'timeString': '2025-11', 'timeType': 'MONTH', 'slot_status': {'formula': 'filled', 'time': 'filled'}, 'value': None, 'note': 'âœ… é«˜ç‚‰å·¥åºèƒ½è€—å®ç»©æŠ¥å‡ºå€¼ åœ¨ 2025-11 (MONTH) çš„å€¼æš‚æ— æ•°æ®ã€‚', 'formula_candidates': None}]}}   
2025-12-04 12:38:04,209 | INFO | context_graph | ğŸ•˜ add_history: å¯¹æ¯”ä¸Šæœˆæœ‰ä»€ä¹ˆå˜åŒ– -> ç”±äºä¸¤ä¸ªæŸ¥è¯¢éƒ½æœªè¿”å›æœ‰æ•ˆæ•°æ®ï¼Œæ— æ³•å¯¹ä»»ä½•æŒ‡æ ‡è¿›è¡Œæ¯”è¾ƒã€‚ 
2025-12-04 12:38:04,210 | INFO | context_graph | ğŸ§¹ main_intent cleared.
Single Query Reply 2: ç”±äºä¸¤ä¸ªæŸ¥è¯¢éƒ½æœªè¿”å›æœ‰æ•ˆæ•°æ®ï¼Œæ— æ³•å¯¹ä»»ä½•æŒ‡æ ‡è¿›è¡Œæ¯”è¾ƒã€‚