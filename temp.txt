ğŸŸ¢ ç™»å½•è¿”å›ï¼š {'error': None, 'data': {'token': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiIxMDU0IiwidGVuYW50aWQiOiIxMDUiLCJ1bmFtZSI6IuW8gOaUvuaOiOadg--8muiDvea6kOeuoeeQhiIsInRuYW1lIjoi5a6d6ZKi5rmb5rGf6ZKi6ZOB5pyJ6ZmQ5YWs5Y-4IiwidHNpZGUiOiIxIiwiZ3JvdXBpZCI6IjAiLCJzbGlkaW5nIjoiMCIsInJzaW5jZSI6IjE3NjEwOTkxODQiLCJuYmYiOjE3NjA5NTQ4ODQsImV4cCI6MTc2MTA3MDY4NCwiaXNzIjoic2hiYW9uZW5nIiwiYXVkIjoic2hiYW9uZW5nIn0.HuQp7cPscuyHyVW-6uO71YDkG6-FeRvw-0u6bMtCN-I', 'expiresAt': '2025-10-22 02:17:04', 'tenantId': 105, 'tenancyName': 'zjis', 'userId': 1054, 'userName': 'ecshare'}, 'status': 200, 'msg': 'æ“ä½œæˆåŠŸ', 'duration': -1}
{'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiIxMDU0IiwidGVuYW50aWQiOiIxMDUiLCJ1bmFtZSI6IuW8gOaUvuaOiOadg--8muiDvea6kOeuoeeQhiIsInRuYW1lIjoi5a6d6ZKi5rmb5rGf6ZKi6ZOB5pyJ6ZmQ5YWs5Y-4IiwidHNpZGUiOiIxIiwiZ3JvdXBpZCI6IjAiLCJzbGlkaW5nIjoiMCIsInJzaW5jZSI6IjE3NjEwOTkxODQiLCJuYmYiOjE3NjA5NTQ4ODQsImV4cCI6MTc2MTA3MDY4NCwiaXNzIjoic2hiYW9uZW5nIiwiYXVkIjoic2hiYW9uZW5nIn0.HuQp7cPscuyHyVW-6uO71YDkG6-FeRvw-0u6bMtCN-I', 'Content-Type': 'application/json'}
{'expressionList': {'GXNHLT1100.IXRL': 'GXNHLT1100.IXRL'}, 'clock': '2022-10-02', 'timegranId': 'DAY'}
{'error': None, 'data': None, 'status': 500, 'msg': 'è°ƒç”¨å¤±è´¥', 'duration': 0}
æŸ¥è¯¢ç»“æœï¼š None

http://www.shbaoenergy.com:8081/api/api/services/Runtime/Authentication/UserTrustLoginAsync

192.168.122.7 www.shbaoenergy.com

{
    "appId":"EC",
    "userName":"ec@share",
    "tenancyName":"zjis",
    "timestamp":1755593290049,
    "enc":"B1F6BCE403B31D8E75D834F90C9B990B"
}



package com.baosight.demo.controller;

import com.baosight.iplat4j.core.web.threadlocal.UserSession;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.http.*;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping("/NGOAuth")
public class NGOAuthController {

    @Value("${NGOAuth.TenantName}")
    private String tenantName;

    @Value("${NGOAuth.AppKey}")
    private String appKey;

    @Value("${NGOAuth.AppSecret}")
    private String appSecret;

    @Value("${NGOAuth.PlatformApiDomain}")
    private String platformApiDomain;

    @Value("${NGOAuth.PlatformDomain}")
    private String platformDomain;

    private final RestTemplate restTemplate = new RestTemplate();
    private final ObjectMapper mapper = new ObjectMapper();

    /**
     * åˆå¹¶åçš„ OAuth ç™»å½•å…¥å£ï¼š
     * ç›´æ¥ç”¨ code æ¢ç”¨æˆ·ä¿¡æ¯ï¼Œç”Ÿæˆ ENCï¼Œå¹¶é‡å®šå‘åˆ° TrustLogin
     */
    @GetMapping("/Login")
    public void login(@RequestParam(required = false) String returnUrl,
                      HttpServletRequest request,
                      HttpServletResponse response) throws Exception {
        // ä¿è¯ returnUrl æ ¼å¼æ­£ç¡®
        if (returnUrl != null) {
            returnUrl = returnUrl.replaceAll("^https?://[^/]+", "");
        }
        String redirectUrl = (returnUrl == null || returnUrl.trim().isEmpty())
                ? platformDomain + "/"
                : platformDomain + returnUrl;
        // è·å–å½“å‰java4jç”¨æˆ·ä¿¡æ¯ï¼ŒTODO:éœ€è¦è°ƒç”¨èƒ½æºæŸ¥è¯¢å½“å‰ç”¨æˆ·å­˜åœ¨ï¼Œç„¶ååšæ–°å¢ç”¨æˆ·æ“ä½œï¼Œè´µå”è®©æˆ‘å…ˆç”¨ç”¨æˆ·ç®¡ç†çš„æµ‹ï¼Œä½†æ˜¯è‚¯å®šæ²¡æœ‰åŒ¿åæ¥å£æ‰
        String loginName = UserSession.getLoginName();
        String loginCName = UserSession.getLoginCName();
        String userId = UserSession.getUserUuid();
        // æ„é€ å‚æ•°
        String userName = "liyin";
        long ts = System.currentTimeMillis();
        String enc = md5(tenantName + ":" + appKey + ":" + userName + ":" + ts + ":" + appSecret);

        Map<String, Object> body = new HashMap<>();
        body.put("appId", appKey);
        body.put("userName", userName);
        body.put("tenancyName", tenantName);
        body.put("timestamp", ts);
        body.put("enc", enc);

        // æ„é€  HTTP è¯·æ±‚
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        HttpEntity<Map<String, Object>> requestEntity = new HttpEntity<>(body, headers);

        String apiUrl = platformApiDomain + "/api/services/Runtime/Authentication/UserTrustLoginAsync";

        ResponseEntity<String> apiResponse = restTemplate.postForEntity(apiUrl, requestEntity, String.class);

        if (apiResponse.getStatusCode() == HttpStatus.OK) {
            JsonNode json = mapper.readTree(apiResponse.getBody());
            if (json.has("status") && "200".equals(json.get("status").asText()) &&
                    json.has("data") && json.get("data").has("token")) {
                String token = json.get("data").get("token").asText();
                // å†™å…¥ Cookie
                Cookie cookie = new Cookie("acct", token);
                cookie.setPath("/");
                //cookie.setDomain("localhost"); // è¿™é‡Œå¿…é¡»å’Œ nginx å¯¹å¤–åŸŸåä¸€è‡´
                cookie.setHttpOnly(true);
                response.addCookie(cookie);

                // é‡å®šå‘å›åŸå§‹ returnUrl
                response.sendRedirect(redirectUrl);
                return;
            }
        }

        response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "ç™»å½•å¤±è´¥");
    }

    // åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰ AuthToken cookie
    private boolean hasAuthToken(HttpServletRequest request) {
        if (request.getCookies() != null) {
            for (Cookie cookie : request.getCookies()) {
                if ("acct".equals(cookie.getName()) && cookie.getValue() != null && !cookie.getValue().isEmpty()) {
                    return true;
                }
            }
        }
        return false;
    }

    /**
     * è‡ªå®šä¹‰ç™»å½•åœ¨nginxä»£ç†æƒ…å†µä¸‹ä¼šä¸åœé‡å®šå‘
     */
    public void trustLogin(@RequestParam(required = false) String returnUrl,
                      HttpServletRequest request,
                      HttpServletResponse response) throws Exception {

        HttpSession session = request.getSession(true);

        // å·²ç»ç™»å½•è¿‡ï¼Œç›´æ¥è·³è½¬ç›®æ ‡é¡µé¢ï¼Œä¸å†æ‹¼ TrustLogin
        if ("true".equals(session.getAttribute("loggedIn"))) {
            String redirectUrl = platformDomain; // é»˜è®¤é¦–é¡µ
            if (returnUrl != null && !returnUrl.trim().isEmpty()) {
                // å»æ‰è¿œç«¯åè®®/IP/ç«¯å£ï¼Œåªä¿ç•™è·¯å¾„
                String path = returnUrl.replaceAll("^https?://[^/]+", "");
                // æ‹¼æ¥æœ¬åœ° platformDomainï¼ˆå«ç«¯å£ï¼‰
                redirectUrl = platformDomain + path;
            }
            response.sendRedirect(redirectUrl);
            return;
        }

        // 1. å»æ‰ returnUrl ä¸­çš„åè®®/IP/ç«¯å£ï¼Œåªä¿ç•™è·¯å¾„
        if (returnUrl != null) {
            returnUrl = returnUrl.replaceAll("^https?://[^/]+", "");
        }
        // 2. å¦‚æœ returnUrl ä¸ºç©ºï¼Œåˆ™è·³åˆ°é¦–é¡µ
        //if (returnUrl == null || returnUrl.trim().isEmpty()) {
        //    returnUrl = "/";
        //}
        // âš ï¸ è¿™é‡Œä¸è¦å¯¹å®Œæ•´ URL å†åš URLEncoder.encode(platformDomain + returnUrl) From chatgpt
        // è¿™é‡Œå¿…é¡»è¦URLEncoder.encodeï¼Œä¸ç„¶ä¼šè·³è½¬åˆ°http://192.168.122.179:8081/EP.Web/EC.Web/v/EC/NYMC42
        returnUrl = (returnUrl == null || returnUrl.trim().isEmpty()) ? "/" : URLEncoder.encode(platformDomain + returnUrl, "UTF-8");

        // 3. è·å–ç”¨æˆ·åï¼ˆç¤ºä¾‹ï¼‰
        String userName = "liyin";

        // 4. ç”Ÿæˆ ENC
        long ts = System.currentTimeMillis();
        String enc = md5(tenantName + ":" + appKey + ":" + userName + ":" + ts + ":" + appSecret);

        // 5. æ‹¼æ¥ TrustLogin URL
        String trustLoginUrl = platformApiDomain + "/TrustLogin/Login"
                + "?appId=" + appKey
                + "&username=" + URLEncoder.encode(userName, "UTF-8") // query å‚æ•°ç¼–ç 
                + "&TenancyName=" + tenantName
                + "&Timestamp=" + ts
                + "&Enc=" + enc
                + "&returnUrl=" + returnUrl; // ä¿ç•™åŸè·¯å¾„ï¼Œä¸å†ç¼–ç 

        // 6. è®¾ç½®ç™»å½•æ ‡è®°
        session.setAttribute("loggedIn", "true");

        // 7. é‡å®šå‘
        response.sendRedirect(trustLoginUrl);
    }


    /** ç™»å‡º */
    @GetMapping("/Logout")
    public void logout(HttpServletRequest request, HttpServletResponse response) throws Exception {
        // 1. è·å–å½“å‰ä¼šè¯
        HttpSession session = request.getSession(false);
        if (session != null) {
            // æ ‡è®°å·²æ³¨é”€ï¼ˆiPlat4J å¯ç”¨æ­¤æ ‡è¯†åœ¨å‰ç«¯æ‹¦æˆªï¼‰
            session.setAttribute("iplat.logout", "1");
            // é”€æ¯ä¼šè¯
            session.invalidate();
        }
        // 2. æ¸…é™¤ Spring Security ç™»å½•ä¿¡æ¯
        SecurityContextHolder.clearContext();
        // 3. ç»Ÿä¸€è®¤è¯ç™»å‡ºåœ°å€ï¼ˆå¯ä»é…ç½®æ–‡ä»¶è¯»å–ï¼‰
        String logoutUrl = "https://sso.example.com/logout"; // æ”¹æˆå®é™… SSO ç™»å‡ºåœ°å€
        // 4. ç™»å‡ºåå›è·³åœ°å€ï¼ˆè¿™é‡Œè·³å›ç³»ç»Ÿé¦–é¡µæˆ–ç™»å½•é¡µï¼‰
        String returnUrl = "http://localhost:8090/kqenergy"; // æ”¹æˆå®é™…åº”ç”¨å…¥å£
        //String redirectUrl = logoutUrl + "?service=" + URLEncoder.encode(returnUrl, "UTF-8");
        // 5. é‡å®šå‘åˆ° SSO ç™»å‡º
        response.sendRedirect(returnUrl);
    }

    /** ç”Ÿæˆ MD5ï¼ˆå¤§å†™ï¼‰ */
    private String md5(String text) throws Exception {
        MessageDigest md = MessageDigest.getInstance("MD5");
        byte[] digest = md.digest(text.getBytes(StandardCharsets.UTF_8));
        StringBuilder sb = new StringBuilder();
        for (byte b : digest) {
            sb.append(String.format("%02X", b));
        }
        return sb.toString();
    }

    /** Java 8 å…¼å®¹ isBlank */
    private static boolean isBlank(String str) {
        return str == null || str.trim().isEmpty();
    }
}
